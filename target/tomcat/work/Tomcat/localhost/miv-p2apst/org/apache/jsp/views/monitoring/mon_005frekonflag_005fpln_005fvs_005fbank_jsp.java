/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.47
 * Generated at: 2025-10-27 03:14:59 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp.views.monitoring;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;

public final class mon_005frekonflag_005fpln_005fvs_005fbank_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html;charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("<style>\r\n");
      out.write("    /* CSS TABLE REKAP - SAMAKAN DENGAN TABEL Detail */\r\n");
      out.write("    #tablemon_upi {\r\n");
      out.write("        table-layout: fixed;\r\n");
      out.write("        width: 100%; /* Lebar default 100% */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #tablemon_upi th,\r\n");
      out.write("    #tablemon_upi td {\r\n");
      out.write("        white-space: nowrap;\r\n");
      out.write("        overflow: hidden;\r\n");
      out.write("        text-overflow: ellipsis;\r\n");
      out.write("        padding: 4px 6px;\r\n");
      out.write("        font-size: 0.7rem;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* Target wrapper DataTables untuk memastikan lebar 100% tidak terlampaui */\r\n");
      out.write("    #tablemon_upi_wrapper {\r\n");
      out.write("        width: 100%;\r\n");
      out.write("        max-width: 100%;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .dataTables_scrollHeadInner, \r\n");
      out.write("    .dataTables_scrollHead table,\r\n");
      out.write("    .dataTables_scrollBody table {\r\n");
      out.write("        width: 100% !important;\r\n");
      out.write("        /* Tambahkan min-width agar ketika DataTables kosong tidak terlalu menyusut */\r\n");
      out.write("        min-width: 100%;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* ðŸ’¡ Tambahkan class untuk tabel itu sendiri untuk memastikan tidak melebihi 100% */\r\n");
      out.write("    #tablemon_upi {\r\n");
      out.write("        max-width: 100%; \r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("     /* Tambahan jika mau batas tinggi + scroll seperti modal */\r\n");
      out.write("    #tablemon_upi_wrapper .dataTables_scrollBody {\r\n");
      out.write("        max-height: 65vh;       /* Sesuaikan tinggi maksimal seperti modal */\r\n");
      out.write("        overflow-y: auto;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* CSS MODAL SHOW TABLE MONITORING Detail */\r\n");
      out.write("    #dataModal .modal-body {\r\n");
      out.write("        font-size: 0.75rem; /* Ukuran teks diperkecil */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #dataModal table th,\r\n");
      out.write("    #dataModal table td {\r\n");
      out.write("        font-size: 0.7rem;   /* Ukuran teks header dan isi tabel */\r\n");
      out.write("        padding: 4px 6px;    /* Padding dikurangi agar tidak terlalu lebar */\r\n");
      out.write("        white-space: nowrap; /* Hindari pemisahan baris */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #dataModal table {\r\n");
      out.write("        table-layout: auto; /* Gunakan auto agar kolom menyesuaikan konten */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* Pastikan form-container relatif */\r\n");
      out.write("    .form-monitoring {\r\n");
      out.write("        position: relative;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* âœ… HAPUS .datatable-container jika tidak digunakan */\r\n");
      out.write("    /* .datatable-container {\r\n");
      out.write("        overflow-x: auto;\r\n");
      out.write("        width: 100%;\r\n");
      out.write("    } */\r\n");
      out.write("\r\n");
      out.write("    /* Buat spinner tetap di tengah form tapi transparan */\r\n");
      out.write("    .loading-overlay {\r\n");
      out.write("        position: absolute;\r\n");
      out.write("        top: 50%;\r\n");
      out.write("        left: 50%;\r\n");
      out.write("        transform: translate(-50%, -50%);\r\n");
      out.write("        z-index: 1050;\r\n");
      out.write("        text-align: center;\r\n");
      out.write("        font-size: 0.95rem;\r\n");
      out.write("        /* Tidak ada background, padding, atau box */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* tambah lebar large modal */\r\n");
      out.write("    .modal-xxl {\r\n");
      out.write("        max-width: 98% !important; /* Atur sesuai kebutuhan */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* legenda tulisan hedar dan kotak  */\r\n");
      out.write("    .form-box {\r\n");
      out.write("        border: 1px solid #ddd;\r\n");
      out.write("        border-radius: 4px;\r\n");
      out.write("        padding: 20px;\r\n");
      out.write("        margin: 20px 0;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .form-box legend {\r\n");
      out.write("        font-weight: bold;\r\n");
      out.write("        font-size: 1rem;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .form-box fieldset {\r\n");
      out.write("        border: none;\r\n");
      out.write("        padding: 0;\r\n");
      out.write("        margin: 0;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #bln_usulan {\r\n");
      out.write("        text-transform: uppercase;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* ----------\r\n");
      out.write("       Spiner css\r\n");
      out.write("       ----------\r\n");
      out.write("    */\r\n");
      out.write("    #loadingSpinner {\r\n");
      out.write("        display: none;\r\n");
      out.write("        position: fixed;\r\n");
      out.write("        top: 20%;\r\n");
      out.write("        left: 50%;\r\n");
      out.write("        transform: translate(-50%, 0);\r\n");
      out.write("        z-index: 9999;\r\n");
      out.write("        /* background-color: rgba(255, 255, 255, 0.7); */\r\n");
      out.write("        padding: 20px 30px;\r\n");
      out.write("        border-radius: 6px;\r\n");
      out.write("        /* box-shadow: 0 0 10px rgba(0,0,0,0.2); */\r\n");
      out.write("        text-align: center;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #loadingSpinner .spinner-content {\r\n");
      out.write("        text-align: center;\r\n");
      out.write("        font-size: 1.2rem;\r\n");
      out.write("        color: #333;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .overlay-spinner {\r\n");
      out.write("        position: absolute;\r\n");
      out.write("        top: 40%;\r\n");
      out.write("        left: 45%;\r\n");
      out.write("        z-index: 1060;\r\n");
      out.write("    }\r\n");
      out.write("    \r\n");
      out.write("</style>\r\n");
      out.write("\r\n");
      out.write("<!-- âœ… Spinner universal (bisa dipakai rekap & detail) -->\r\n");
      out.write("<div id=\"spinnerOverlay\"\r\n");
      out.write("     class=\"hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 \r\n");
      out.write("            z-[9999] flex-col items-center justify-center bg-white bg-opacity-80 \r\n");
      out.write("            p-4 rounded-lg shadow-lg pointer-events-none\">\r\n");
      out.write("    <div class=\"border-4 border-blue-500 border-t-transparent rounded-full w-8 h-8 animate-spin\"></div>\r\n");
      out.write("    <span class=\"text-xs text-gray-600 mt-2 font-medium\">Loading...</span>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<fieldset class=\"border border-gray-300 rounded p-5 mt-4\">\r\n");
      out.write("    <legend class=\"text-sm font-bold px-3\">Monitoring Rekon PLN Vs Bank</legend>\r\n");
      out.write("\r\n");
      out.write("    <div class=\"mt-1 relative\">\r\n");
      out.write("        <form id=\"form-monitoring\">\r\n");
      out.write("            <div class=\"grid grid-cols-12 gap-3 mb-2 items-end\">\r\n");
      out.write("                <div class=\"col-span-12 md:col-span-4 lg:col-span-3\">\r\n");
      out.write("                    <label for=\"bln_usulan\" class=\"block text-gray-700 mb-1 font-medium\">Bulan Laporan :</label>\r\n");
      out.write("                    <div class=\"flex border border-gray-300 rounded items-center\">\r\n");
      out.write("                        <input \r\n");
      out.write("                            type=\"text\" \r\n");
      out.write("                            id=\"bln_usulan\" \r\n");
      out.write("                            class=\"flex-1 px-3 py-2 text-sm uppercase focus:outline-none focus:ring-1 focus:ring-blue-500\" \r\n");
      out.write("                            placeholder=\"Pilih Bulan Laporan\" \r\n");
      out.write("                            readonly\r\n");
      out.write("                        >\r\n");
      out.write("                        <i id=\"calendarIcon\" class=\"fa fa-calendar text-gray-500 px-3 cursor-pointer hover:text-blue-600\"></i>\r\n");
      out.write("                    </div>\r\n");
      out.write("                    <input type=\"hidden\" id=\"bln_usulan_value\" name=\"bln_usulan_value\">\r\n");
      out.write("                </div>\r\n");
      out.write("\r\n");
      out.write("                <div class=\"col-span-6 md:col-span-2\">\r\n");
      out.write("                    <label class=\"block md:hidden\">&nbsp;</label>\r\n");
      out.write("                    <button id=\"btnTampil\" type=\"button\" class=\"max-w-[120px] w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-3 py-2 rounded shadow flex items-center justify-center gap-2 transition duration-150 ease-in-out\">\r\n");
      out.write("                        <i class=\"fa fa-search\"></i>\r\n");
      out.write("                        <span>Tampilkan</span>\r\n");
      out.write("                    </button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </form>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <div class=\"mt-4 relative min-h-[150px]\">\r\n");
      out.write("        <div class=\"mb-2\">\r\n");
      out.write("            <button id=\"btnExportMonRkpAllExcel2\" class=\"bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow flex items-center gap-2 transition duration-150 ease-in-out\">\r\n");
      out.write("                <i class=\"fa-solid fa-file-excel\"></i> <span>Download Excel Rekap</span>\r\n");
      out.write("            </button>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("        <div class=\"mt-4 relative\">\r\n");
      out.write("            <div class=\"overflow-x-auto w-full\">\r\n");
      out.write("                <table id=\"tablemon_upi\" class=\"table-auto border border-gray-300 w-full text-xs display\">\r\n");
      out.write("                    <thead class=\"bg-gray-100\">\r\n");
      out.write("                        <tr>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">NO</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">NAMA_DIST</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">PRODUK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">BANK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">BULAN</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">PLN_IDPEL</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">PLN_RPTAG</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">PLN_LB_LUNAS</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">PLN_RP_LUNAS</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">BANK_IDPEL</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">BANK_RPTAG</th>\r\n");
      out.write("                            <th class=\"px-2 py-1 text-center border\">SELISIH_RPTAG</th>\r\n");
      out.write("                        </tr>\r\n");
      out.write("                    </thead>\r\n");
      out.write("                    <tbody class=\"text-xs\"></tbody>\r\n");
      out.write("                </table>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</fieldset>\r\n");
      out.write("\r\n");
      out.write("<!-- modal menapilkan detail -->\r\n");
      out.write("<div id=\"dataModal\" class=\"fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50\">\r\n");
      out.write("    <!-- <div class=\"bg-white rounded-lg w-[95%] max-w-7xl max-h-[90vh] overflow-hidden flex flex-col shadow-xl\"> -->\r\n");
      out.write("    <div class=\"bg-white rounded-lg w-full max-w-full max-h-[90vh] overflow-hidden flex flex-col shadow-xl\">\r\n");
      out.write("        <div class=\"flex justify-between items-center p-4 border-b bg-gray-50\">\r\n");
      out.write("            <h5 class=\"text-gray-700 font-bold text-lg\">Detail Data Rekon \r\n");
      out.write("                <span id=\"detailTitle\" class=\"text-blue-600 font-normal\"></span></h5>\r\n");
      out.write("            <button id=\"closeModalBtn\" class=\"text-gray-500 hover:text-gray-700 text-2xl font-bold transition duration-150 ease-in-out\">&times;</button>\r\n");
      out.write("        </div>\r\n");
      out.write("        \r\n");
      out.write("        <div class=\"p-4 flex-1 overflow-auto relative\"> \r\n");
      out.write("            <div class=\"mb-2\">\r\n");
      out.write("                <button id=\"btnExportMonDftAllExcelOneSheet\" class=\"bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded shadow flex items-center gap-2 transition duration-150 ease-in-out\">\r\n");
      out.write("                    <i class=\"fa fa-file-excel\"></i>\r\n");
      out.write("                    <span>Export Detail Per-UPI</span>\r\n");
      out.write("                </button>\r\n");
      out.write("            </div>\r\n");
      out.write("\r\n");
      out.write("            <div class=\"overflow-x-auto w-full\">\r\n");
      out.write("                <table id=\"table_mondaf_upi\" class=\"table-auto border border-gray-300 w-full text-xs display\">\r\n");
      out.write("                    <thead class=\"bg-gray-100\">\r\n");
      out.write("                        <tr>\r\n");
      out.write("                            <th class=\"px-2 py-1\">NO</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PRODUK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">TGLAPPROVE</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">KD_DIST</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">VA</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">SATKER</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_NOUSULAN</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_IDPEL</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_BLTH</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_LUNAS_H0</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_RPTAG</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_RPBK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_TGLBAYAR</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_JAMBAYAR</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_USERID</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">PLN_KDBANK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_NOUSULAN</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_IDPEL</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_BLTH</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_RPTAG</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_RPBK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_TGLBAYAR</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_JAMBAYAR</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_USERID</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">BANK_KDBANK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">SELISIH_RPTAG</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">SELISIH_BK</th>\r\n");
      out.write("                            <th class=\"px-2 py-1\">KETERANGAN</th>\r\n");
      out.write("                        </tr>\r\n");
      out.write("                    </thead>\r\n");
      out.write("                    <tbody class=\"text-xs\">\r\n");
      out.write("                    </tbody>\r\n");
      out.write("                </table>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("        \r\n");
      out.write("        <div class=\"p-4 border-t flex justify-end bg-gray-50\">\r\n");
      out.write("            <button id=\"closeModalBtn2\" class=\"bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded shadow transition duration-150 ease-in-out\">Tutup</button>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<script>\r\n");
      out.write("    // Tampilkan spinner\r\n");
      out.write("    function showSpinner() {\r\n");
      out.write("        const spinner = document.getElementById('spinnerOverlay');\r\n");
      out.write("        spinner.classList.remove('hidden');\r\n");
      out.write("        spinner.classList.add('flex');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    function hideSpinner() {\r\n");
      out.write("        const spinner = document.getElementById('spinnerOverlay');\r\n");
      out.write("        spinner.classList.add('hidden');\r\n");
      out.write("        spinner.classList.remove('flex');\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    // --- GLOBAL VARIABLES (Diambil dari JSP context) ---\r\n");
      out.write("    const CONTEXT_PATH = \"");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${pageContext.request.contextPath}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
      out.write("\";\r\n");
      out.write("\r\n");
      out.write("    // --- UTILITY FUNCTIONS ---\r\n");
      out.write("    function getContextPath() {\r\n");
      out.write("        return CONTEXT_PATH;\r\n");
      out.write("    }\r\n");
      out.write("    \r\n");
      out.write("    // Fungsi format angka (dipanggil dari DataTables render)\r\n");
      out.write("    function formatNumber(value, fractionDigits = 0) {\r\n");
      out.write("        if (value === null || value === undefined || String(value).trim() === '') return '0';\r\n");
      out.write("        \r\n");
      out.write("        let cleanValue = String(value).replace(/\\./g, '').replace(/,/g, '.');\r\n");
      out.write("\r\n");
      out.write("        const number = parseFloat(cleanValue);\r\n");
      out.write("        if (isNaN(number)) return value;\r\n");
      out.write("\r\n");
      out.write("        return number.toLocaleString('id-ID', {\r\n");
      out.write("            minimumFractionDigits: fractionDigits,\r\n");
      out.write("            maximumFractionDigits: fractionDigits\r\n");
      out.write("        });\r\n");
      out.write("    }\r\n");
      out.write("    \r\n");
      out.write("    // Parameter global untuk transfer data dari tabel Rekap ke tabel Detail\r\n");
      out.write("    let detailFilterParams = {};\r\n");
      out.write("    let table_detail_upi = null; // Deklarasi global agar dapat diakses oleh tombol Export\r\n");
      out.write("\r\n");
      out.write("    // --- END UTILITY FUNCTIONS ---\r\n");
      out.write("\r\n");
      out.write("    document.addEventListener('DOMContentLoaded', function() {\r\n");
      out.write("        // Mendapatkan referensi spinner\r\n");
      out.write("        const spinnerRekap = $('#spinnerOverlay');\r\n");
      out.write("        const spinnerDetail = $('#spinnerOverlay');\r\n");
      out.write("        \r\n");
      out.write("        // 1) --- Modal Setup ---\r\n");
      out.write("        const modal = document.getElementById('dataModal');\r\n");
      out.write("        const detailTitle = document.getElementById('detailTitle');\r\n");
      out.write("        const closeBtns = [document.getElementById('closeModalBtn'), document.getElementById('closeModalBtn2')];\r\n");
      out.write("\r\n");
      out.write("        closeBtns.forEach(btn => {\r\n");
      out.write("            if(btn && modal) btn.addEventListener('click', () => {\r\n");
      out.write("                modal.classList.add('hidden');\r\n");
      out.write("                modal.classList.remove('flex');\r\n");
      out.write("            });\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // 2) --- Flatpickr Month Picker ---\r\n");
      out.write("        const blnUsulan = document.getElementById('bln_usulan');\r\n");
      out.write("        const blnUsulanValue = document.getElementById('bln_usulan_value');\r\n");
      out.write("        const calendarIcon = document.getElementById('calendarIcon');\r\n");
      out.write("\r\n");
      out.write("        const fp = flatpickr(blnUsulan, {\r\n");
      out.write("            locale: \"id\", \r\n");
      out.write("            plugins: [new monthSelectPlugin({\r\n");
      out.write("                shorthand: false,\r\n");
      out.write("                dateFormat: \"F Y\",\r\n");
      out.write("                altFormat: \"Y-m\"\r\n");
      out.write("            })],\r\n");
      out.write("            defaultDate: new Date(),\r\n");
      out.write("            onChange: function(selectedDates, dateStr, instance) {\r\n");
      out.write("                const date = selectedDates[0];\r\n");
      out.write("                if(date) {\r\n");
      out.write("                    const yyyy = date.getFullYear();\r\n");
      out.write("                    const mm = String(date.getMonth() + 1).padStart(2,'0');\r\n");
      out.write("                    blnUsulanValue.value = yyyy+mm;\r\n");
      out.write("                }\r\n");
      out.write("            },\r\n");
      out.write("            onReady: function(selectedDates, dateStr, instance) {\r\n");
      out.write("                const date = selectedDates[0];\r\n");
      out.write("                if(date) {\r\n");
      out.write("                    const yyyy = date.getFullYear();\r\n");
      out.write("                    const mm = String(date.getMonth() + 1).padStart(2,'0');\r\n");
      out.write("                    blnUsulanValue.value = yyyy+mm;\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        calendarIcon.addEventListener('click', () => fp.open());\r\n");
      out.write("        \r\n");
      out.write("        // 3) --- DataTables Rekap (tablemon_upi) ---\r\n");
      out.write("        var table = $('#tablemon_upi').DataTable({\r\n");
      out.write("            processing: false,\r\n");
      out.write("            serverSide: true,\r\n");
      out.write("            scrollX: true, \r\n");
      out.write("            paging: false,\r\n");
      out.write("            ordering: false,\r\n");
      out.write("            searching: false, \r\n");
      out.write("            autoWidth: false,\r\n");
      out.write("            info: false,\r\n");
      out.write("            stripeClasses: [],\r\n");
      out.write("            ajax: {\r\n");
      out.write("                url: getContextPath() + '/mon-rekon-bankvsperupi', // Ganti dengan URL Servlet yang benar\r\n");
      out.write("                type: 'POST',\r\n");
      out.write("                data: function (d) {\r\n");
      out.write("                    // Ambil dari hidden input (YYYYMM)\r\n");
      out.write("                    const yyyymm = $('#bln_usulan_value').val();\r\n");
      out.write("                    d.vbln_usulan = yyyymm;\r\n");
      out.write("                },\r\n");
      out.write("                error: function (xhr, error, thrown) {\r\n");
      out.write("                    spinnerRekap.removeClass('flex').addClass('hidden'); \r\n");
      out.write("                    // Tambahkan notifikasi error jika perlu\r\n");
      out.write("                }\r\n");
      out.write("            },\r\n");
      out.write("            deferLoading: 0,\r\n");
      out.write("            columns: [\r\n");
      out.write("                {\r\n");
      out.write("                    data: null, // NO\r\n");
      out.write("                    render: function (data, type, row, meta) {\r\n");
      out.write("                        // Hanya tampilkan nomor jika bukan baris total (URUT 5)\r\n");
      out.write("                        if (row.URUT != 5) {\r\n");
      out.write("                            return meta.row + 1;\r\n");
      out.write("                        } else {\r\n");
      out.write("                            return ''; \r\n");
      out.write("                        }\r\n");
      out.write("                    },\r\n");
      out.write("                    width: '30px'\r\n");
      out.write("                },\r\n");
      out.write("                {\r\n");
      out.write("                    data: null, // NAMA_DIST\r\n");
      out.write("                    render: function (data, type, row) {\r\n");
      out.write("                        const text = row.KD_DIST && row.NAMA_DIST ? row.KD_DIST + ' - ' + row.NAMA_DIST : '';\r\n");
      out.write("                        return row.URUT == 5 ? `<strong>TOTAL</strong>` : text;\r\n");
      out.write("                    },\r\n");
      out.write("                    width: '250px'\r\n");
      out.write("                },\r\n");
      out.write("                { data: 'PRODUK', defaultContent: '', width: '80px' },\r\n");
      out.write("                { data: 'BANK' , defaultContent: '', width: '200px'},\r\n");
      out.write("                { data: 'BLN_USULAN', defaultContent: '', width: '70px' },\r\n");
      out.write("                // Angka\r\n");
      out.write("                { data: 'PLN_IDPEL', render: function (data) { return formatNumber(data, 0); }, width: '100px' },\r\n");
      out.write("                { data: 'PLN_RPTAG', render: function (data) { return formatNumber(data, 0); }, width: '120px' },\r\n");
      out.write("                { data: 'PLN_LEBAR_LUNAS', render: function (data) { return formatNumber(data, 0); }, width: '100px' },\r\n");
      out.write("                { data: 'PLN_RPTAG_LUNAS', render: function (data) { return formatNumber(data, 0); }, width: '120px' },\r\n");
      out.write("                { data: 'BANK_IDPEL', render: function (data) { return formatNumber(data, 0); }, width: '100px' },\r\n");
      out.write("                { data: 'BANK_RPTAG', render: function (data) { return formatNumber(data, 0); }, width: '120px' },\r\n");
      out.write("                { data: 'SELISIH_RPTAG', render: function (data) { return formatNumber(data, 0); }, width: '120px' }\r\n");
      out.write("            ],\r\n");
      out.write("            columnDefs: [\r\n");
      out.write("                { targets: '_all', defaultContent: '', className: 'align-middle' },   // tengah vertikal\r\n");
      out.write("                { targets: [1, 3, 4], className: 'text-left' },       // kolom kiri dulu\r\n");
      out.write("                { targets: [0, 5, 6, 7, 8, 9, 10, 11], className: 'text-right' }, // sisanya kanan\r\n");
      out.write("            ],\r\n");
      out.write("            createdRow: function (row, data, dataIndex) {\r\n");
      out.write("                // Styling untuk baris TOTAL\r\n");
      out.write("                if (data.URUT == 5) {\r\n");
      out.write("                    $(row).addClass('font-bold bg-gray-200');\r\n");
      out.write("                    $('td', row).css('border-top', '3px solid #000');\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                // Logic untuk klik/link\r\n");
      out.write("                // const clickableColumns = [5, 6, 9, 10]; // Index kolom: PLN_IDPEL, PLN_RPTAG, BANK_IDPEL, BANK_RPTAG\r\n");
      out.write("                // const columnNames = ['PLN_IDPEL', 'PLN_RPTAG', 'BANK_IDPEL', 'BANK_RPTAG'];\r\n");
      out.write("                const clickableColumns = [5, 6]; // Index kolom: PLN_IDPEL, PLN_RPTAG\r\n");
      out.write("                const columnNames = ['PLN_IDPEL', 'PLN_RPTAG'];\r\n");
      out.write("\r\n");
      out.write("                $('td', row).each(function (colIndex) {\r\n");
      out.write("                    if (clickableColumns.includes(colIndex)) {\r\n");
      out.write("                        const columnName = columnNames[clickableColumns.indexOf(colIndex)];\r\n");
      out.write("                        const cellValue = data[columnName];\r\n");
      out.write("                        \r\n");
      out.write("                        // Cek jika nilainya > 0 dan bukan baris total (URUT 5)\r\n");
      out.write("                        if (data.URUT != 5 && cellValue && parseFloat(String(cellValue).replace(/\\./g, '').replace(/,/g, '.')) > 0) {\r\n");
      out.write("                            $(this).addClass('cursor-pointer text-blue-600 underline').off('click').on('click', function () {\r\n");
      out.write("                                // Set parameter filter global\r\n");
      out.write("                                detailFilterParams = {\r\n");
      out.write("                                    vbln_usulan: data.BLN_USULAN,\r\n");
      out.write("                                    vkd_bank: data.BANK ? data.BANK.substring(0, 3) : '', // Ambil 3 karakter pertama bank\r\n");
      out.write("                                    vkd_dist: data.KD_DIST,\r\n");
      out.write("                                    vproduk: data.PRODUK\r\n");
      out.write("                                };\r\n");
      out.write("                                \r\n");
      out.write("                                // Update judul modal\r\n");
      out.write("                                detailTitle.textContent = \"(\"+data.KD_DIST+\" - \"+data.NAMA_DIST+\" | \"+data.BANK+\")\";\r\n");
      out.write("\r\n");
      out.write("                                // Tampilkan Modal\r\n");
      out.write("                                modal.classList.remove('hidden');\r\n");
      out.write("                                modal.classList.add('flex');\r\n");
      out.write("                                \r\n");
      out.write("                                // Muat ulang tabel detail dengan parameter baru\r\n");
      out.write("                                if(table_detail_upi) {\r\n");
      out.write("                                    // Tampilkan spinner detail saat memuat ulang\r\n");
      out.write("                                    spinnerDetail.removeClass('hidden').addClass('flex');\r\n");
      out.write("                                    table_detail_upi.ajax.reload();\r\n");
      out.write("                                }\r\n");
      out.write("                            });\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                });\r\n");
      out.write("            },\r\n");
      out.write("            // Konfigurasi Export\r\n");
      out.write("            dom: 'lfrtip', \r\n");
      out.write("            buttons: [\r\n");
      out.write("                {\r\n");
      out.write("                    extend: 'excelHtml5',\r\n");
      out.write("                    title: 'MIV_REKON_REKAP_' + ($('#bln_usulan_value').val() ? $('#bln_usulan_value').val() : 'ALL'),\r\n");
      out.write("                    className: 'd-none',\r\n");
      out.write("                    exportOptions: {\r\n");
      out.write("                        format: {\r\n");
      out.write("                            body: function (data, row, column, node) {\r\n");
      out.write("                                // Kolom angka (index 5 sampai 11) di-export tanpa format ribuan\r\n");
      out.write("                                const columnsRaw = [5,6,7,8,9,10,11]; \r\n");
      out.write("                                if (columnsRaw.includes(column)) {\r\n");
      out.write("                                    if (typeof data === 'string') {\r\n");
      out.write("                                        // Hapus format ribuan (titik) sebelum diekspor\r\n");
      out.write("                                        return data.replace(/\\./g, '').replace(/,/g, ''); \r\n");
      out.write("                                    }\r\n");
      out.write("                                }\r\n");
      out.write("                                return data;\r\n");
      out.write("                            }\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            ] \r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // 4) --- DataTables Detail (table_mondaf_upi) ---\r\n");
      out.write("        table_detail_upi = $('#table_mondaf_upi').DataTable({\r\n");
      out.write("            processing: false, // Diganti dengan spinner manual\r\n");
      out.write("            serverSide: true,\r\n");
      out.write("            scrollX: true, \r\n");
      out.write("            paging: true,\r\n");
      out.write("            ordering: false,\r\n");
      out.write("            searching: false, \r\n");
      out.write("            autoWidth: false,\r\n");
      out.write("            info: true,\r\n");
      out.write("            stripeClasses: [],\r\n");
      out.write("            lengthMenu: [ [10, 25, 50, 1000], [10, 25, 50, 1000] ],\r\n");
      out.write("            pageLength: 10,\r\n");
      out.write("            ajax: {\r\n");
      out.write("                url: getContextPath() + '//mon-rekon-bankvsperupi', // Perlu dicek apakah URL ini benar untuk detail\r\n");
      out.write("                type: 'POST',\r\n");
      out.write("                data: function (d) {\r\n");
      out.write("                    // Gunakan parameter yang disimpan dari klik rekap\r\n");
      out.write("                    d.act       = 'detailData';\r\n");
      out.write("                    d.vbln_usulan = detailFilterParams.vbln_usulan || ''; \r\n");
      out.write("                    d.vkd_bank  = detailFilterParams.vkd_bank || '';\r\n");
      out.write("                    d.vkd_dist  = detailFilterParams.vkd_dist || '';\r\n");
      out.write("                    d.vproduk   = detailFilterParams.vproduk || '';\r\n");
      out.write("                },\r\n");
      out.write("                error: function (xhr, error, thrown) {\r\n");
      out.write("                    spinnerDetail.removeClass('flex').addClass('hidden');\r\n");
      out.write("                    // Handle error detail\r\n");
      out.write("                }\r\n");
      out.write("            },\r\n");
      out.write("            columns: [\r\n");
      out.write("                { data: null, render: function (data, type, row, meta) { return meta.row + 1 + meta.settings._iDisplayStart; } },\r\n");
      out.write("                { data: 'PRODUK', defaultContent: '' },\r\n");
      out.write("                { data: 'TGLAPPROVE', defaultContent: '' },\r\n");
      out.write("                { data: 'KD_DIST', defaultContent: '' },\r\n");
      out.write("                { data: 'VA', defaultContent: '' },\r\n");
      out.write("                { data: 'SATKER', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_NOUSULAN', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_IDPEL', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_BLTH', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_LUNAS_H0', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_RPTAG', render: function (data) { return formatNumber(data, 0); } },\r\n");
      out.write("                { data: 'PLN_RPBK', render: function (data) { return formatNumber(data, 0); } },\r\n");
      out.write("                { data: 'PLN_TGLBAYAR', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_JAMBAYAR', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_USERID', defaultContent: '' },\r\n");
      out.write("                { data: 'PLN_KDBANK', defaultContent: '' },\r\n");
      out.write("                { data: 'BANK_NOUSULAN', defaultContent: '' },\r\n");
      out.write("                { data: 'BANK_IDPEL', defaultContent: '' },\r\n");
      out.write("                { data: 'BANK_BLTH', defaultContent: '' },\r\n");
      out.write("                { data: 'BANK_RPTAG', render: function (data) { return formatNumber(data, 0); } },\r\n");
      out.write("                { data: 'BANK_RPBK', render: function (data) { return formatNumber(data, 0); } },\r\n");
      out.write("                { data: 'BANK_TGLBAYAR', defaultContent: '' },\r\n");
      out.write("                { data: 'BANK_JAMBAYAR', defaultContent: '' },\r\n");
      out.write("                { data: 'BANK_USERID', defaultContent: '' },\r\n");
      out.write("                { data: 'BANK_KDBANK', defaultContent: '' },\r\n");
      out.write("                { data: 'SELISIH_RPTAG', render: function (data) { return formatNumber(data, 0); } },\r\n");
      out.write("                { data: 'SELISIH_BK', render: function (data) { return formatNumber(data, 0); } },\r\n");
      out.write("                { data: 'KETERANGAN', defaultContent: '' }\r\n");
      out.write("            ],\r\n");
      out.write("            columnDefs: [\r\n");
      out.write("                { targets: [10, 11, 19, 20, 25, 26], className: 'text-right' }, // Kolom angka\r\n");
      out.write("                { targets: '_all', className: 'text-center' }\r\n");
      out.write("            ],\r\n");
      out.write("            // Konfigurasi Export Detail\r\n");
      out.write("            // dom: 'Bfrtip',\r\n");
      out.write("            dom: 'lfrtip', \r\n");
      out.write("            buttons: [\r\n");
      out.write("                {\r\n");
      out.write("                    extend: 'excelHtml5',\r\n");
      out.write("                    title: function() {\r\n");
      out.write("                        const bln = detailFilterParams.vbln_usulan || 'ALL';\r\n");
      out.write("                        const dist = detailFilterParams.vkd_dist || 'UNDEF';\r\n");
      out.write("                        return `MIV_REKON_DETAIL_");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${dist}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
      out.write('_');
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${bln}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
      out.write("`;\r\n");
      out.write("                    },\r\n");
      out.write("                    className: 'd-none',\r\n");
      out.write("                    exportOptions: {\r\n");
      out.write("                        // Export semua kolom\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            ]\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("        // 5) --- Event Handlers (Spinner) ---\r\n");
      out.write("        // Spinner Rekap (hanya untuk area tabel rekap)\r\n");
      out.write("        // table.on('preXhr.dt', function () {\r\n");
      out.write("        //     spinnerRekap.removeClass('hidden').addClass('flex');  \r\n");
      out.write("        // });\r\n");
      out.write("\r\n");
      out.write("        table.on('preXhr.dt', function() {\r\n");
      out.write("            showSpinner();\r\n");
      out.write("        }).on('xhr.dt', function() {\r\n");
      out.write("            hideSpinner();\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        table.on('xhr.dt', function () {\r\n");
      out.write("            spinnerRekap.removeClass('flex').addClass('hidden');   \r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("        // Spinner Detail (hanya untuk area modal detail)\r\n");
      out.write("        $('#table_mondaf_upi').on('preXhr.dt', function() {\r\n");
      out.write("             showSpinner();\r\n");
      out.write("        }).on('xhr.dt', function() {\r\n");
      out.write("            hideSpinner();\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("        // 6) --- Event Handlers (Tombol) ---       \r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        // 1A-1) Tampilkan monitoring Rekap\r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        $(document).ready(function () {\r\n");
      out.write("            $('#btnTampil').on('click', function () {\r\n");
      out.write("                if (!$('#bln_usulan_value').val()) {\r\n");
      out.write("                    alert(\"Silakan pilih Bulan Laporan terlebih dahulu!\");\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("                // Tampilkan spinner Rekap secara manual sebelum reload\r\n");
      out.write("                spinnerRekap.removeClass('hidden').addClass('flex');  \r\n");
      out.write("                 \r\n");
      out.write("                // setelah inisialisasi\r\n");
      out.write("                table.columns.adjust().draw();\r\n");
      out.write("\r\n");
      out.write("                table.ajax.reload();\r\n");
      out.write("            });\r\n");
      out.write("        });\r\n");
      out.write("        \r\n");
      out.write("        // Trigger Download Excel Rekap\r\n");
      out.write("        $('#btnExportMonRkpAllExcel2').on('click', function () {\r\n");
      out.write("            table.button(0).trigger();\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // ----------------------------------------------------------------------------\r\n");
      out.write("        // 1B-2) Export ke exel semua data MON Detail\r\n");
      out.write("        // ----------------------------------------------------------------------------\r\n");
      out.write("        // Fungsi format angka ribuan (lokal Indonesia)\r\n");
      out.write("        const formatRibuan = (angka) => new Intl.NumberFormat('id-ID').format(angka);\r\n");
      out.write("\r\n");
      out.write("        // Ambil nama Bank MIV dari DB\r\n");
      out.write("        async function fetchNamaBank(kodeBank) {\r\n");
      out.write("            const params = new URLSearchParams();\r\n");
      out.write("            params.append('act', 'getNamaBank');\r\n");
      out.write("            params.append('kdbank', kodeBank);\r\n");
      out.write("\r\n");
      out.write("            const response = await fetch(getContextPath() + '/mon-rekon-bankvsperupi', {\r\n");
      out.write("                method: 'POST',\r\n");
      out.write("                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n");
      out.write("                body: params.toString()\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            if (!response.ok) throw new Error(\"Gagal mengambil data bank\");\r\n");
      out.write("\r\n");
      out.write("            const json = await response.json();\r\n");
      out.write("            if (json.status !== 'success') return '';\r\n");
      out.write("\r\n");
      out.write("            return json.data.NAMA_BANK || '';\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        // Ambil nama UID/UIW PLN MIV dari DB\r\n");
      out.write("        async function fetchNamaUnitUPI(kd_dist) {\r\n");
      out.write("            const params = new URLSearchParams();\r\n");
      out.write("            params.append('act', 'getNamaUnitUPI');\r\n");
      out.write("            params.append('kd_dist', kd_dist);\r\n");
      out.write("\r\n");
      out.write("            const response = await fetch(getContextPath() + '/mon-rekon-bankvsperupi', {\r\n");
      out.write("                method: 'POST',\r\n");
      out.write("                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n");
      out.write("                body: params.toString()\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            if (!response.ok) throw new Error(\"Gagal mengambil data UNITUPI\");\r\n");
      out.write("\r\n");
      out.write("            const json = await response.json();\r\n");
      out.write("            if (json.status !== 'success') return '';\r\n");
      out.write("\r\n");
      out.write("            return json.data.NAMA_DIST || '';\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        $('#btnExportMonDftAllExcelOneSheet').on('click', async function () {\r\n");
      out.write("            const btn = $(this);\r\n");
      out.write("            let totalLoaded = 0;\r\n");
      out.write("\r\n");
      out.write("            spinnerDetail.removeClass('hidden').addClass('flex');\r\n");
      out.write("            await new Promise(resolve => setTimeout(resolve, 30));\r\n");
      out.write("\r\n");
      out.write("            btn.prop('disabled', true).html('<i class=\"fa fa-spinner fa-spin\"></i> <span>Memuat... (' + formatRibuan(totalLoaded) + \" data)</span>\");\r\n");
      out.write("\r\n");
      out.write("            const vbln_usulan = detailFilterParams.vbln_usulan;\r\n");
      out.write("            const vkd_bank = detailFilterParams.vkd_bank;\r\n");
      out.write("            const vkd_dist = detailFilterParams.vkd_dist;\r\n");
      out.write("            const vproduk = detailFilterParams.vproduk;\r\n");
      out.write("\r\n");
      out.write("            if (!vbln_usulan || !vkd_bank || !vkd_dist) {\r\n");
      out.write("                alert('Silakan lengkapi filter terlebih dahulu!');\r\n");
      out.write("                btn.prop('disabled', false).html('<i class=\"fa fa-file-excel\"></i> <span>Export Detail Per-UPI</span>');\r\n");
      out.write("                spinnerDetail.removeClass('flex').addClass('hidden');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            let namaBank = '';\r\n");
      out.write("            let namaUPI  = '';\r\n");
      out.write("            try {\r\n");
      out.write("                namaBank = await fetchNamaBank(vkd_bank);\r\n");
      out.write("                if (vkd_dist === '00') {\r\n");
      out.write("                    namaUPI  = '00 - SAKTI'\r\n");
      out.write("                } else {\r\n");
      out.write("                    namaUPI  = (await fetchNamaUnitUPI(vkd_dist));\r\n");
      out.write("                }\r\n");
      out.write("                const pageSize = 1000;\r\n");
      out.write("                let start = 0;\r\n");
      out.write("                let allData = [];\r\n");
      out.write("                let drawCounter = 1;\r\n");
      out.write("\r\n");
      out.write("                const headers = {\r\n");
      out.write("                    PRODUK: 'PRODUK', TGLAPPROVE: 'TGL APPROVE', KD_DIST: 'KD DIST', VA: 'VA', SATKER: 'SATKER',\r\n");
      out.write("                    PLN_NOUSULAN: 'PLN NO USULAN', PLN_IDPEL: 'PLN IDPEL', PLN_BLTH: 'PLN BLTH', PLN_LUNAS_H0: 'PLN LUNAS H0',\r\n");
      out.write("                    PLN_RPTAG: 'PLN RPTAG', PLN_RPBK: 'PLN RPBK', PLN_TGLBAYAR: 'PLN TGL BAYAR', PLN_JAMBAYAR: 'PLN JAM BAYAR',\r\n");
      out.write("                    PLN_USERID: 'PLN USER ID', PLN_KDBANK: 'PLN KD BANK', BANK_NOUSULAN: 'BANK NO USULAN',\r\n");
      out.write("                    BANK_IDPEL: 'BANK IDPEL', BANK_BLTH: 'BANK BLTH', BANK_RPTAG: 'BANK RPTAG', BANK_RPBK: 'BANK RPBK',\r\n");
      out.write("                    BANK_TGLBAYAR: 'BANK TGL BAYAR', BANK_JAMBAYAR: 'BANK JAM BAYAR', BANK_USERID: 'BANK USER ID', BANK_KDBANK: 'BANK KD BANK',\r\n");
      out.write("                    SELISIH_RPTAG: 'SELISIH RPTAG', SELISIH_BK: 'SELISIH BK', KETERANGAN: 'KETERANGAN'\r\n");
      out.write("                };\r\n");
      out.write("                \r\n");
      out.write("                let totalRecords = 0;\r\n");
      out.write("\r\n");
      out.write("                while (true) {\r\n");
      out.write("                    const params = new URLSearchParams();\r\n");
      out.write("                    params.append('act', 'detailData');\r\n");
      out.write("                    params.append('vbln_usulan', vbln_usulan);\r\n");
      out.write("                    params.append('vkd_bank', vkd_bank);\r\n");
      out.write("                    params.append('vkd_dist', vkd_dist);\r\n");
      out.write("                    params.append('vproduk', vproduk);\r\n");
      out.write("                    params.append('start', start);\r\n");
      out.write("                    params.append('length', pageSize);\r\n");
      out.write("                    params.append('draw', drawCounter++);\r\n");
      out.write("                    params.append('order[0][column]', '0');\r\n");
      out.write("                    params.append('order[0][dir]', 'asc');\r\n");
      out.write("                    params.append('columns[0][data]', 'KD_DIST');\r\n");
      out.write("                    params.append('search[value]', '');\r\n");
      out.write("\r\n");
      out.write("                    const response = await fetch(getContextPath() + '/mon-rekon-bankvsperupi', {\r\n");
      out.write("                        method: 'POST',\r\n");
      out.write("                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n");
      out.write("                        body: params.toString()\r\n");
      out.write("                    });\r\n");
      out.write("\r\n");
      out.write("                    if (!response.ok) {\r\n");
      out.write("                        const errorText = await response.text();\r\n");
      out.write("                        throw new Error('Status: ' + response.status + '\\n' + errorText);\r\n");
      out.write("                    }\r\n");
      out.write("\r\n");
      out.write("                    const json = await response.json();\r\n");
      out.write("                    const data = json.data;\r\n");
      out.write("                    totalRecords = json.recordsTotal;\r\n");
      out.write("                    \r\n");
      out.write("                    if (!data || data.length === 0) break;\r\n");
      out.write("\r\n");
      out.write("                    const formatted = data.map((item) => {\r\n");
      out.write("                        const row = {};\r\n");
      out.write("                        Object.keys(headers).forEach(key => {\r\n");
      out.write("                            // Cek jika field adalah angka, biarkan sebagai angka (Excel akan memformatnya)\r\n");
      out.write("                            if (['PLN_RPTAG', 'PLN_RPBK', 'BANK_RPTAG', 'BANK_RPBK', 'SELISIH_RPTAG', 'SELISIH_BK'].includes(key)) {\r\n");
      out.write("                                row[key] = parseFloat(String(item[key] || '0').replace(/\\./g, '').replace(/,/g, '.')) || 0;\r\n");
      out.write("                            } else {\r\n");
      out.write("                                row[key] = String(item[key] || '');\r\n");
      out.write("                            }\r\n");
      out.write("                        });\r\n");
      out.write("                        return row;\r\n");
      out.write("                    });\r\n");
      out.write("\r\n");
      out.write("                    allData = allData.concat(formatted);\r\n");
      out.write("                    totalLoaded += data.length;\r\n");
      out.write("                    \r\n");
      out.write("                    btn.html('<i class=\"fa fa-spinner fa-spin\"></i> <span>Memuat... (' + formatRibuan(totalLoaded) + \"/\" + formatRibuan(totalRecords) + \" data)</span>\");\r\n");
      out.write("                    await new Promise(resolve => setTimeout(resolve, 10));\r\n");
      out.write("\r\n");
      out.write("                    if (data.length < pageSize || totalLoaded >= totalRecords) break;\r\n");
      out.write("\r\n");
      out.write("                    start += pageSize;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                if (allData.length === 0) {\r\n");
      out.write("                    alert('Tidak ada data untuk diekspor!');\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                // --- Proses Excel Export (Menggunakan SheetJS/js-xlsx) ---\r\n");
      out.write("                // Asumsi Anda sudah memiliki library SheetJS (xlsx.full.min.js) di halaman Anda\r\n");
      out.write("                \r\n");
      out.write("                const Workbook = XLSX.utils.book_new();\r\n");
      out.write("                \r\n");
      out.write("                // Buat timestamp dan judul\r\n");
      out.write("                const now = new Date();\r\n");
      out.write("                const dd = String(now.getDate()).padStart(2, '0');\r\n");
      out.write("                const mm = String(now.getMonth() + 1).padStart(2, '0');\r\n");
      out.write("                const yyyy = now.getFullYear();\r\n");
      out.write("                const hh = String(now.getHours()).padStart(2, '0');\r\n");
      out.write("                const mi = String(now.getMinutes()).padStart(2, '0');\r\n");
      out.write("                const ss = String(now.getSeconds()).padStart(2, '0');\r\n");
      out.write("                const timestamp = dd + \"/\" + mm + \"/\" + yyyy + \" \" + hh + \":\" + mi + \":\" + ss;\r\n");
      out.write("                \r\n");
      out.write("                // Susun data untuk Header Informasi\r\n");
      out.write("                const headerInfo = [\r\n");
      out.write("                    [\"MIV REKON DETAIL\"],\r\n");
      out.write("                    [\"BULAN\", \": \"+ vbln_usulan.substring(4, 6) + '/' + vbln_usulan.substring(0, 4) ],\r\n");
      out.write("                    [\"UID/UIW\", \": \"+ namaUPI ],\r\n");
      out.write("                    [\"BANK MIV\", \": \" + vkd_bank + (namaBank ? \" - \" + namaBank : '') ],\r\n");
      out.write("                    [\"PRODUK\", \": \" + vproduk ],\r\n");
      out.write("                    [\"TOTAL DATA\", \": \" + formatRibuan(totalLoaded) ],\r\n");
      out.write("                    [\"TANGGAL DOWNLOAD\", \": \"+ timestamp],\r\n");
      out.write("                    [] // Baris kosong sebelum header tabel\r\n");
      out.write("                ];\r\n");
      out.write("                \r\n");
      out.write("                // Konversi data array ke format sheet\r\n");
      out.write("                const ws_info = XLSX.utils.aoa_to_sheet(headerInfo);\r\n");
      out.write("\r\n");
      out.write("                // Tambahkan header tabel (kolom NO manual)\r\n");
      out.write("                const ws_data = [\r\n");
      out.write("                    ['NO', ...Object.values(headers)] \r\n");
      out.write("                ];\r\n");
      out.write("\r\n");
      out.write("                // Tambahkan data detail\r\n");
      out.write("                allData.forEach((row, index) => {\r\n");
      out.write("                    const dataRow = [index + 1];\r\n");
      out.write("                    Object.keys(headers).forEach(key => {\r\n");
      out.write("                        dataRow.push(row[key]);\r\n");
      out.write("                    });\r\n");
      out.write("                    ws_data.push(dataRow);\r\n");
      out.write("                });\r\n");
      out.write("                \r\n");
      out.write("                // Konversi data tabel ke format sheet\r\n");
      out.write("                const ws_table = XLSX.utils.aoa_to_sheet(ws_data);\r\n");
      out.write("                \r\n");
      out.write("                // Gabungkan kedua sheet (info dan data)\r\n");
      out.write("                XLSX.utils.sheet_add_aoa(ws_info, ws_data, { origin: \"A10\" }); // Mulai data tabel dari baris A10\r\n");
      out.write("                \r\n");
      out.write("                // Styling (opsional, hanya untuk sel tertentu)\r\n");
      out.write("                // ws_info['A1'].s = { font: { bold: true, sz: 14 } }; // Judul\r\n");
      out.write("                // for (let i = 0; i < 7; i++) {\r\n");
      out.write("                //     ws_info['A' + (i + 2)].s = { font: { bold: true } }; // Label info\r\n");
      out.write("                // }\r\n");
      out.write("                \r\n");
      out.write("                // Tambahkan sheet ke Workbook\r\n");
      out.write("                XLSX.utils.book_append_sheet(Workbook, ws_info, \"Detail Rekon\");\r\n");
      out.write("\r\n");
      out.write("                // Nama File\r\n");
      out.write("                const fileName = `MIV_REKON_DETAIL_");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${vkd_dist}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
      out.write('_');
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${vbln_usulan}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
      out.write(".xlsx`;\r\n");
      out.write("                \r\n");
      out.write("                // Tulis dan download file\r\n");
      out.write("                XLSX.writeFile(Workbook, fileName);\r\n");
      out.write("\r\n");
      out.write("            } catch (error) {\r\n");
      out.write("                console.error(\"Error during full export:\", error);\r\n");
      out.write("                alert('Gagal mengekspor data: ' + error.message);\r\n");
      out.write("            } finally {\r\n");
      out.write("                btn.prop('disabled', false).html('<i class=\"fa fa-file-excel\"></i> <span>Export Detail Per-UPI</span>');\r\n");
      out.write("                spinnerDetail.removeClass('flex').addClass('hidden');\r\n");
      out.write("            }\r\n");
      out.write("        });\r\n");
      out.write("    });\r\n");
      out.write("</script>");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
